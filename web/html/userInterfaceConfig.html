<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floaty - Interface</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
<style>
    .mainFrame {
        padding: 10px 20px 0 20px;
    }
    table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }

    td, th {
        border: 1px solid #dddddd;
        padding: 8px;
    }
    .actionMenu {
        margin-right: 20px;
        display: flex;
        justify-items: right  ;
        flex-direction: column;
        align-items: flex-end;
    }
    .actionMenu > * {
        display: flex;
        margin-top: 7px;
        justify-items: inherit;
    }
    .popup-content > h4 {
        margin-bottom: 10px;
    }
    .popup-content {
        background: #444444;
        border: 4px #222222 solid;
        color: white;
        margin: 0 15px 10px 0;
        padding: 10px 20px 10px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .popup-content > * {
        margin-top: 7px;
    }
    .actionBtn {
        /*border: none;*/
        /*color: white;*/
        /*background-color: ;*/
    }
    .modifiedCell {
        border: #526f8c solid 3px;
    }
    .actionBtn {
        background-color: #222;
        color: #fff;
        font-family: century gothic;
        border: black solid;
        border-size: 3px;
    }
    .introCont {
        display: flex;
        flex-direction: column;
        align-items: center;
        border: red solid 3px;
        background-color: #222;
        color: white;

    }
</style>
{{{navbarControlFile}}}

<div class="introCont">
    <h3>Данная страница является инструментов для изменения данных в шаблоне.</h3>
    <h3>Никому не передавайте значение ссылки этой страницы, она содержит в себе общий ключ доступа.</h3>
</div>
<!--Region Table-->
<div id="popupTable" class="popup">
    <div class="popup-content">
        <span class="closeTable-btn close-btn">&times;</span>
        <h4>Загрузка данных</h4>
        <br><br>
        <button id="submitTable-btn">Показать</button>
    </div>
</div>
<!--End Table-->


<div class="actionMenu">
    <button id="getTable-btn" class="actionBtn" >Показать</button>

    <div class="redact">
        <button id="openRedactMode-btn" class="actionBtn" >Редактировать</button>
        <button id="confirmChangesTable-btn" class="actionBtn" style="display: none;" >Подтвердить изменения</button>
    </div>

</div>
<div class="mainFrame">
    <div class="contentFrame">
        <table id="rootTable">
            <thead style="background-color: #F5DEB3"><tr><th colspan="7" >ПАТРОНАЖНЫЙ ЖУРНАЛ - ШАБЛОН <span id="journalTitle"></span> </th></tr></thead>
            <tr id="rootTableHeader">
                <th id="nameClass">Класс</th>
                <th id="amount">Кол-во учащихся</th>
                <th id="absent_amount">Кол-во отсутствующих в классе</th>
                <th id="absent_virus">Фамилии отсутствующих по ОРВИ</th>
                <th id="absent_resp">Фамилии отсутствующих по УП</th>
                <th id="absent_nonResp">Фамилии отсутствующих не по УП</th>
                <th id="absent_freeMeal">Из них бесплатники</th>
            </tr>
            <tbody id="rootTableBody"></tbody>
        </table>
        <div style="height: 100px; background-color:#333; border: none;"><a id="itogo"></a></div>
    </div>
</div>
<script>
    let urlParams = new URLSearchParams(location.search);
    let isRedactorModeEntered = false;
    let isTableLoaded = false;
    let dataTable;
    let changesList = {"classes": {}};
    function fillTable(jres, date = "") {
        let rootTable = document.getElementById('rootTableBody');
        let journalTitle = document.getElementById('journalTitle');
        let optRow;
        let classes = jres["classes"];
        let numClass;
        let letterClass;
        let nameClass;


        //Fill date
        if (date !== "") journalTitle.innerText = " | " + date;

        //Filling cells
        for(let i in classes) { //num
            numClass = classes[i];
            for (letterClass in numClass) { //num -> letter
                // * Get name of class
                nameClass = numClass[letterClass].name;
                let numAndLetter = nameClass.split('_');
                nameClass = numAndLetter[0] + numAndLetter[1];

                // * Row
                optRow = document.createElement('tr');

                // * Row Name
                let optCellName = document.createElement('td');
                optCellName.innerText = nameClass;
                optRow.append(optCellName);

                // * Row base amount
                let optCellPropAmount = document.createElement('td');
                if (classes[i][letterClass].amount === null || classes[i][letterClass].amount.length === 0) {
                    optCellPropAmount.innerText = 0;
                } else {
                    optCellPropAmount.innerText = classes[i][letterClass].amount;
                }
                optRow.append(optCellPropAmount)

                let mapAbsent = new Map();
                // * Set map of props
                for (let el in classes[i][letterClass].absent) {
                    let optCellPropAbsent = document.createElement('td');
                    if (classes[i][letterClass].absent[el] === null || classes[i][letterClass].absent[el].length === 0) {
                        if (el !== "amount") optCellPropAbsent.innerText = '-';
                        else optCellPropAbsent.innerText = 0;
                    } else {
                        optCellPropAbsent.innerText = classes[i][letterClass].absent[el];
                    }
                    mapAbsent.set(el, optCellPropAbsent);
                }
                optRow.append(mapAbsent.get("amount"));
                optRow.append(mapAbsent.get("listVirusCause"));
                optRow.append(mapAbsent.get("listRespCause"));
                optRow.append(mapAbsent.get("listNonRespCause"));
                optRow.append(mapAbsent.get("listFreeMeal"));

                rootTable.append(optRow);

            }
        }
    }

    function getTemplateForTable() {
        //delete previous table

        if (isTableLoaded === true) {
            document.getElementById('rootTableBody').innerHTML = '';
        }
        fetch('/api/getDataClassesInterface', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schoolId: urlParams.get("schoolId"),
                method: 'getTemplateCase',
                key: urlParams.get("key")
            })
        })
            .then(res => {
                const jres = res.json()
                    .then(jres => {
                        fillTable(jres);
                    })
                isTableLoaded = true;
            })
    }


    //Region redactor mode

document.getElementById("openRedactMode-btn").addEventListener('click', function() {
    let rootTableHeader = document.getElementById('rootTableHeader')
    let rootTable = document.getElementById('rootTableBody');

    function getTableData() {
        let data = {};
        for (let row=0;row< rootTable.children.length; row++) {
            for (let cell = 0; cell <  rootTable.children[row].children.length; cell++) {
                rootTable.children[row].children[cell].id = rootTableHeader.children[cell].id;
            }
        }

        for (let row=0;row< rootTable.children.length; row++) {
            for (let cell = 0; cell <  rootTable.children[row].children.length; cell++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.value = rootTable.children[row].children[cell].innerText;
                input.style.width = '80px';
                rootTable.children[row].children[cell].name
                rootTable.children[row].children[cell].innerText = '';
                rootTable.children[row].children[cell].appendChild(input);
            }
        }

        let rowData = [];
        if (JSON.stringify(data).length === 0 || '{}') {
            for (let row= 0;row < rootTable.children.length; row++) {
                for (let cell = 0; cell <  rootTable.children[row].children.length; cell++) {
                    rowData.push(rootTable.children[row].children[cell].firstChild.valueOf().value);
                }
                data[row] = rowData;
                rowData = [];
            }
        }
        console.log(data);
        return data;
    }
    function insertData(data) {

        let jsonObj = {};

        for (let row=0;row< rootTable.children.length; row++) {
            jsonObj = {};
            for (let cell = 0; cell <  rootTable.children[row].children.length; cell++) {

                rootTable.children[row].children[cell].innerHTML = rootTable.children[row].children[cell].firstChild.valueOf().value;

                if (rootTable.children[row].children[cell].innerHTML !== data[row][cell]) {
                    jsonObj[rootTable.children[row].children[cell].id] = rootTable.children[row].children[cell].innerHTML;
                    rootTable.children[row].children[cell].className += 'modifiedCell';
                }
                if (jsonObj[rootTable.children[row].children[cell].id] !== undefined) {
                    changesList['classes'][rootTable.children[row].children[0].innerHTML] = jsonObj;
                }
            }
        }

        console.log(changesList);

    }
    switch (isRedactorModeEntered) {
        case false:
            document.getElementById("openRedactMode-btn").innerHTML = 'Сохранить изменения у себя';
            document.getElementById('confirmChangesTable-btn').style.display = 'none';
            dataTable = getTableData();
            isRedactorModeEntered = true;
            break;

        case true:
            document.getElementById("openRedactMode-btn").innerHTML = 'Редактировать';
            document.getElementById('confirmChangesTable-btn').style.display = 'flex';
            isRedactorModeEntered = false;
            insertData(dataTable);
            break;

    }

})

document.getElementById('confirmChangesTable-btn').addEventListener('click', function () {
    if (isRedactorModeEntered) {
        alert('Сначало сохраните изменения')
        return;
    }
    if (confirm("Вы уверены? Данные, которые были изменены будут внесены на сервер.")) {

        alert('oke')
    }
    else {
        alert('ne oke')

    }
})

//End redactor mode


//Region getTableForDate
document.getElementById('getTable-btn').addEventListener('click', function() {
    document.getElementById('popupTable').style.display = 'block';
});
document.querySelector('.closeTable-btn').addEventListener('click', function() {
    document.getElementById('popupTable').style.display = 'none';
});


document.getElementById('submitTable-btn').addEventListener('click', function() {
        getTemplateForTable();
        document.getElementById('popupTable').style.display = 'none';
});
//End getTableForDate
</script>

{{{footerFile}}}
</body>

</html>
